<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>WeatheRate TV Pro - Forecast Entry</title>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        />
        <style>
            :root {
                --primary-color: #236aaa;
                --secondary-color: #8fb9d9;
                --success-color: #28a745;
                --danger-color: #dc3545;
                --warning-color: #ffc107;
                --light-bg: #f8f9fa;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background-color: var(--secondary-color);
                min-height: 100vh;
            }

            .navbar-custom {
                background-color: var(--primary-color) !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .navbar-brand {
                font-weight: bold;
            }

            .main-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            .page-header {
                background: white;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 30px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                text-align: center;
            }

            .page-header img {
                max-height: 80px;
                margin-bottom: 20px;
            }

            .forecast-card {
                background: white;
                border-radius: 8px;
                padding: 30px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                margin-bottom: 30px;
            }

            .step-indicator {
                text-align: center;
                margin-bottom: 30px;
                font-weight: bold;
                color: var(--primary-color);
            }

            .date-display {
                text-align: center;
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 20px;
                color: #333;
            }

            .instructions-card {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 30px;
            }

            .forecast-section {
                margin-bottom: 40px;
                padding: 20px;
                border: 1px solid #e9ecef;
                border-radius: 8px;
                background: #fafbfc;
            }

            .section-title {
                font-size: 20px;
                font-weight: bold;
                color: var(--primary-color);
                margin-bottom: 20px;
                text-align: center;
            }

            .temp-input {
                font-size: 18px;
                font-weight: bold;
                text-align: center;
                border: 2px solid #dee2e6;
                border-radius: 4px;
                padding: 10px;
                width: 100px;
            }

            .temp-input:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0.2rem rgba(35, 106, 170, 0.25);
            }

            .temp-input.is-invalid {
                border-color: var(--danger-color);
            }

            .error-message {
                color: var(--danger-color);
                font-weight: bold;
                font-size: 14px;
                margin-top: 5px;
            }

            .radio-group,
            .checkbox-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin: 15px 0;
            }

            .radio-option,
            .checkbox-option {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 5px;
                border-radius: 4px;
            }

            .radio-option:hover,
            .checkbox-option:hover {
                background-color: #f0f0f0;
            }

            .station-info {
                background: linear-gradient(
                    135deg,
                    var(--primary-color),
                    var(--secondary-color)
                );
                color: white;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 30px;
                text-align: center;
            }

            .station-name {
                font-size: 24px;
                font-weight: bold;
                margin-bottom: 10px;
            }

            .station-market {
                font-size: 16px;
                opacity: 0.9;
            }

            .btn-custom {
                background-color: var(--primary-color);
                border-color: var(--primary-color);
                color: white;
                padding: 12px 24px;
                font-weight: bold;
                border-radius: 6px;
            }

            .btn-custom:hover {
                background-color: #1a5490;
                border-color: #1a5490;
                color: white;
            }

            .btn-success-custom {
                background-color: var(--success-color);
                border-color: var(--success-color);
                color: white;
                padding: 12px 24px;
                font-weight: bold;
                border-radius: 6px;
            }

            .btn-success-custom:hover {
                background-color: #218838;
                border-color: #218838;
                color: white;
            }

            .navigation-buttons {
                display: flex;
                justify-content: space-between;
                margin-top: 40px;
                gap: 20px;
            }

            .hidden {
                display: none !important;
            }

            .fade-in {
                animation: fadeIn 0.3s ease-in;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .weather-table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
            }

            .weather-table th {
                background-color: var(--primary-color);
                color: white;
                padding: 12px;
                text-align: center;
                font-weight: bold;
            }

            .weather-table td {
                padding: 15px;
                text-align: center;
                border: 1px solid #dee2e6;
            }

            .status-indicator {
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 14px;
                font-weight: bold;
                text-align: center;
                margin-bottom: 20px;
            }

            .status-saved {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .status-pending {
                background-color: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }

            .status-error {
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            @media (max-width: 768px) {
                .forecast-section {
                    padding: 15px;
                }

                .navigation-buttons {
                    flex-direction: column;
                }

                .radio-group,
                .checkbox-group {
                    font-size: 14px;
                }
            }
        </style>
    </head>
    <body>
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-cloud-sun me-2"></i>
                    WeatheRate TV Pro
                </a>
                <div class="navbar-nav ms-auto">
                    <div class="nav-item dropdown">
                        <a
                            class="nav-link dropdown-toggle"
                            href="#"
                            role="button"
                            data-bs-toggle="dropdown"
                        >
                            <i class="fas fa-user me-1"></i>
                            <span id="userDisplayName">TV Pro</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a
                                    class="dropdown-item"
                                    href="#"
                                    onclick="handleLogout()"
                                >
                                    <i class="fas fa-sign-out-alt me-2"></i>Sign
                                    Out
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-container">
            <!-- Page Header -->
            <div class="page-header">
                <img
                    src="img/logo.png"
                    alt="WeatheRate Logo"
                    class="img-fluid"
                />
                <h2>Enter Forecast</h2>
                <div class="date-display" id="currentDate">
                    Today is Wednesday, November 12, 2025
                </div>
            </div>

            <!-- Station Information -->
            <div class="station-info" id="stationInfo">
                <div class="station-name" id="stationName">
                    Loading Station...
                </div>
                <div class="station-market" id="stationMarket">
                    Loading Market...
                </div>
            </div>

            <!-- Status Indicator -->
            <div class="status-indicator status-pending" id="statusIndicator">
                <i class="fas fa-edit me-2"></i>Complete all fields to submit
                forecast
            </div>

            <!-- Instructions -->
            <div class="text-center mb-4">
                <button
                    class="btn btn-outline-primary"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#instructions"
                >
                    <i class="fas fa-info-circle me-2"></i>Click for
                    Instructions
                </button>
            </div>

            <div class="collapse mb-4" id="instructions">
                <div class="instructions-card">
                    <h5 class="text-center mb-3">
                        Forecast Entry Instructions
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p>
                                <i
                                    class="fas fa-thermometer-half me-2 text-primary"
                                ></i
                                ><strong>Temperatures:</strong> Enter the high
                                temperature for midnight to midnight period.
                            </p>
                            <p>
                                <i class="fas fa-cloud me-2 text-primary"></i
                                ><strong>Sky/Precipitation:</strong> Choose one
                                option for each forecast period.
                            </p>
                            <p>
                                <i class="fas fa-umbrella me-2 text-primary"></i
                                ><strong>Additional Weather:</strong> Choose one
                                or more items if needed.
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p>
                                <i
                                    class="fas fa-snowflake me-2 text-primary"
                                ></i
                                ><strong>Snow Accumulation:</strong> Choose one
                                amount for each period.
                            </p>
                            <p>
                                <i class="fas fa-clock me-2 text-primary"></i
                                ><strong>Precipitation Timing:</strong> Choose
                                timing for Day 1 forecasts if needed.
                            </p>
                            <p>
                                <i class="fas fa-save me-2 text-success"></i
                                ><strong>Save Progress:</strong> Your work is
                                automatically saved as you go.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Forecast Form -->
            <div class="forecast-card">
                <div class="step-indicator">
                    <span id="wizardStepTitle">Day 1</span> - Step
                    <span id="currentStep">1</span> of 3
                </div>

                <!-- Step 1: Day 1 (Day + Night) -->
                <div id="step1" class="wizard-step">
                    <form name="forecast" id="forecastForm" class="pt-3">
                        <input type="hidden" name="forecast_wizard_view-current_step" value="page1" id="id_forecast_wizard_view-current_step">

                        <div class="container-fluid">
                            <!-- Day 1 -->
                            <div class="form-row justify-content-center">
                                <div class="col-sm-auto text-center">
                                    <input type="hidden" name="page1-forecast_date" value="2025-11-13" id="id_page1-forecast_date">
                                    <span class="font-weight-bold">Day 1:<br>
                                        <span id="day1DateDisplay">Thursday, November 13, 2025</span>
                                    </span>
                                    <br><br>
                                    <p>Forecast high temp for<br>midnight to midnight.</p>
                                    <p>Forecast all other items for<br>7am to 10pm.</p>
                                </div>

                                <div class="col-sm-auto pb-2">
                                    <label class="sr-only" for="day1high">Day 1 High</label>
                                    <input type="number" name="page1-high" class="form-control temperature" maxlength="3" placeholder="High°F" id="id_page1-high">
                                    <p id="error-section-0" class="text-danger font-weight-bold temperature"></p>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-primary text-center">
                                            <tr>
                                                <th scope="col" id="sky_precip_high_0"><label>Sky/Precip:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page1-sky_precip_high">
                                                        <div><label><input type="radio" name="page1-sky_precip_high" value="1"> Sunny - P/C</label></div>
                                                        <div><label><input type="radio" name="page1-sky_precip_high" value="2"> M/C - Cloudy</label></div>
                                                        <div><label><input type="radio" name="page1-sky_precip_high" value="3"> Rain</label></div>
                                                        <div><label><input type="radio" name="page1-sky_precip_high" value="4"> Snow</label></div>
                                                        <div><label><input type="radio" name="page1-sky_precip_high" value="5"> Ice</label></div>
                                                        <div><label><input type="radio" name="page1-sky_precip_high" value="6"> Mixed</label></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-primary text-center">
                                            <tr>
                                                <th scope="col" id="additional_high_0"><label>Additional:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page1-additional_high">
                                                        <div><label><input type="checkbox" name="page1-additional_high" value="1"> Severe T-Storm</label></div>
                                                        <div><label><input type="checkbox" name="page1-additional_high" value="2"> Windy</label></div>
                                                        <div><label><input type="checkbox" name="page1-additional_high" value="3"> Dense Fog</label></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-primary text-center">
                                            <tr>
                                                <th scope="col" id="snow_high_0"><label>Snow:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page1-snow_high">
                                                        <div><label><input type="radio" name="page1-snow_high" value="1"> 0.1" - 1.0"</label></div>
                                                        <div><label><input type="radio" name="page1-snow_high" value="2"> 1.1" - 3.0"</label></div>
                                                        <div><label><input type="radio" name="page1-snow_high" value="3"> 3.1" - 6.0"</label></div>
                                                        <div><label><input type="radio" name="page1-snow_high" value="4"> 6.1" +</label></div>
                                                        <div><label><input type="radio" name="page1-snow_high" value="99"> None</label></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-primary text-center">
                                            <tr>
                                                <th scope="col" id="precip_time_high_0"><label>Precip Time:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page1-precip_time_high">
                                                        <div><label><input type="checkbox" name="page1-precip_time_high" value="1"> 7AM-Noon</label></div>
                                                        <div><label><input type="checkbox" name="page1-precip_time_high" value="2"> Noon-6PM</label></div>
                                                        <div><label><input type="checkbox" name="page1-precip_time_high" value="3"> 6PM-10PM</label></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <hr>

                            <!-- Day 1 Night -->
                            <div class="form-row justify-content-center pt-4">
                                <div class="col-sm-auto text-center">
                                    <span class="font-weight-bold">Day 1 Night:<br>
                                        <span id="day1NightDateDisplay">Thursday, November 13, 2025</span>
                                    </span><br>
                                    <p>Typical low temperature forecast is for<br>morning diurnal low.</p>
                                    <p>Forecast low temperature for<br>
                                        <span id="nightTimeRange">10pm Thursday November 13 to approx. 7am Friday November 14.</span>
                                    </p>
                                    <p>Forecast all other items for<br>10pm to 7am.</p>
                                </div>

                                <div class="col-sm-auto pb-2">
                                    <label class="sr-only" for="day1low">Day 1 Low</label>
                                    <input type="number" name="page1-low" class="form-control temperature" maxlength="3" placeholder="Low°F" id="id_page1-low">
                                    <p id="error-section-1" class="text-danger font-weight-bold temperature"></p>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-primary text-center">
                                            <tr>
                                                <th scope="col" id="sky_precip_low_1"><label>Sky/Precip:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page1-sky_precip_low">
                                                        <div><label><input type="radio" name="page1-sky_precip_low" value="1"> Clear - P/C</label></div>
                                                        <div><label><input type="radio" name="page1-sky_precip_low" value="2"> M/C - Cloudy</label></div>
                                                        <div><label><input type="radio" name="page1-sky_precip_low" value="3"> Rain</label></div>
                                                        <div><label><input type="radio" name="page1-sky_precip_low" value="4"> Snow</label></div>
                                                        <div><label><input type="radio" name="page1-sky_precip_low" value="5"> Ice</label></div>
                                                        <div><label><input type="radio" name="page1-sky_precip_low" value="6"> Mixed</label></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-primary text-center">
                                            <tr>
                                                <th scope="col" id="additional_low_1"><label>Additional:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page1-additional_low">
                                                        <div><label><input type="checkbox" name="page1-additional_low" value="1"> Severe T-Storm</label></div>
                                                        <div><label><input type="checkbox" name="page1-additional_low" value="2"> Windy</label></div>
                                                        <div><label><input type="checkbox" name="page1-additional_low" value="3"> Dense Fog</label></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-primary text-center">
                                            <tr>
                                                <th scope="col" id="snow_low_1"><label>Snow:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page1-snow_low">
                                                        <div><label><input type="radio" name="page1-snow_low" value="1"> 0.1" - 1.0"</label></div>
                                                        <div><label><input type="radio" name="page1-snow_low" value="2"> 1.1" - 3.0"</label></div>
                                                        <div><label><input type="radio" name="page1-snow_low" value="3"> 3.1" - 6.0"</label></div>
                                                        <div><label><input type="radio" name="page1-snow_low" value="4"> 6.1" +</label></div>
                                                        <div><label><input type="radio" name="page1-snow_low" value="99"> None</label></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="col-sm-auto">
                                    <!-- Empty placeholder for alignment -->
                                </div>
                            </div>

                            <p class="text-center mt-4">
                                <button type="button" class="btn btn-primary next" onclick="goToStep2()">
                                    <i class="fas fa-arrow-right"></i> Day 2 to Day 4
                                </button>
                            </p>
                        </div>
                    </form>
                </div>

                <!-- Step 2: Days 2-4 -->
                <div id="step2" class="wizard-step" style="display: none;">
                        <input type="hidden" name="forecast_wizard_view-current_step" value="page2" id="id_forecast_wizard_view-current_step">

                        <div class="container-fluid">
                            <!-- Day 2 -->
                            <div class="form-row justify-content-center">
                                <div class="col-sm-auto text-center">
                                    <p>
                                        <input type="hidden" name="page2-0-days_out" value="2" id="id_page2-0-days_out">
                                        <span class="font-weight-bold">Day 2:<br>
                                            <input type="hidden" name="page2-0-forecast_date" value="2025-11-14" id="id_page2-0-forecast_date">
                                            <span id="day2DateDisplay">Friday, November 14, 2025</span>
                                        </span>
                                    </p>
                                    <p>Forecast Sky/Precip, Additional<br>and Snow for 7 AM to 10 PM</p>
                                    <p>Forecast high temp for<br>midnight to midnight</p>
                                    <p>Forecast low temperature for<br>
                                        <span id="day2NightTimeRange">10pm Friday November 14 to approx. 7am Saturday November 15.</span>
                                    </p>
                                </div>

                                <div class="col-sm-auto pb-2">
                                    <label class="sr-only">Day 2 high</label>
                                    <input type="number" name="page2-0-high" class="form-control temperature" maxlength="3" placeholder="High°F" id="id_page2-0-high">
                                    <label class="sr-only">Day 2 low</label>
                                    <input type="number" name="page2-0-low" class="form-control temperature" maxlength="3" placeholder="Low°F" id="id_page2-0-low">
                                    <p id="error-section-2" class="text-danger font-weight-bold temperature"></p>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-primary text-center">
                                            <tr>
                                                <th scope="col" id="sky_precip_2"><label>Sky precip:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page2-0-sky_precip">
                                                        <div><label><input type="radio" name="page2-0-sky_precip" value="1"> Sunny - P/C</label></div>
                                                        <div><label><input type="radio" name="page2-0-sky_precip" value="2"> M/C - Cloudy</label></div>
                                                        <div><label><input type="radio" name="page2-0-sky_precip" value="3"> Rain</label></div>
                                                        <div><label><input type="radio" name="page2-0-sky_precip" value="4"> Snow</label></div>
                                                        <div><label><input type="radio" name="page2-0-sky_precip" value="5"> Ice</label></div>
                                                        <div><label><input type="radio" name="page2-0-sky_precip" value="6"> Mixed</label></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-primary text-center">
                                            <tr>
                                                <th scope="col" id="additional_2"><label>Additional:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page2-0-additional">
                                                        <div><label><input type="checkbox" name="page2-0-additional" value="1"> Severe T-Storm</label></div>
                                                        <div><label><input type="checkbox" name="page2-0-additional" value="2"> Windy</label></div>
                                                        <div><label><input type="checkbox" name="page2-0-additional" value="3"> Dense Fog</label></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-primary text-center">
                                            <tr>
                                                <th scope="col" id="snow_2"><label>Snow:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page2-0-snow">
                                                        <div><label><input type="radio" name="page2-0-snow" value="1"> 0.1" - 1.0"</label></div>
                                                        <div><label><input type="radio" name="page2-0-snow" value="2"> 1.1" - 3.0"</label></div>
                                                        <div><label><input type="radio" name="page2-0-snow" value="3"> 3.1" - 6.0"</label></div>
                                                        <div><label><input type="radio" name="page2-0-snow" value="4"> 6.1" +</label></div>
                                                        <div><label><input type="radio" name="page2-0-snow" value="99" checked> None</label></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-background text-center">
                                            <tr>
                                                <th scope="col" class="text-secondary">Precip Time</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Day 3 -->
                            <div class="row mb-4">
                                <div class="col-sm-auto pb-2">
                                    <h5>Day 3</h5>
                                    <label class="sr-only">Day 3 high</label>
                                    <input type="number" name="page2-1-high" class="form-control temperature" maxlength="3" placeholder="High°F" id="id_page2-1-high">
                                    <label class="sr-only">Day 3 low</label>
                                    <input type="number" name="page2-1-low" class="form-control temperature" maxlength="3" placeholder="Low°F" id="id_page2-1-low">
                                    <p id="error-section-3" class="text-danger font-weight-bold temperature"></p>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-primary text-center">
                                            <tr>
                                                <th scope="col" id="sky_3"><label>Sky/Precip:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page2-1-sky_precip">
                                                        <select name="page2-1-sky_precip" class="form-select">
                                                            <option value="1">Sunny - P/C</option>
                                                            <option value="2">Sunny - AM/PM Clouds</option>
                                                            <option value="3">Sunny - Mostly Sunny</option>
                                                            <option value="4">Sunny - Hazy</option>
                                                            <option value="5">Mostly Sunny</option>
                                                            <option value="6">Partly Cloudy</option>
                                                            <option value="7">Mostly Cloudy</option>
                                                            <option value="8">Cloudy</option>
                                                            <option value="9">Drizzle</option>
                                                            <option value="10">Few Showers</option>
                                                            <option value="11">Showers Likely</option>
                                                            <option value="12">Showers</option>
                                                            <option value="13">T-Storms Likely</option>
                                                            <option value="14">T-Storms Early</option>
                                                            <option value="15">T-Storms Late</option>
                                                            <option value="16">A Few T-Storms</option>
                                                            <option value="17">AM Snow Showers</option>
                                                            <option value="18">PM Snow Showers</option>
                                                            <option value="19">AM T-Storms</option>
                                                            <option value="20">PM T-Storms</option>
                                                            <option value="21">AM Showers</option>
                                                            <option value="22">PM Showers</option>
                                                            <option value="23">AM Clouds/PM Sun</option>
                                                            <option value="24">AM Sun/PM Clouds</option>
                                                            <option value="25">Mostly Cloudy/Wind</option>
                                                            <option value="26">Mostly Sunny/Wind</option>
                                                            <option value="27">Partly Cloudy/Wind</option>
                                                            <option value="28">Few T-Storms</option>
                                                            <option value="29">AM Drizzle</option>
                                                            <option value="30">PM Drizzle</option>
                                                            <option value="31">Rain/Snow Showers</option>
                                                            <option value="32">Wintry Mix</option>
                                                            <option value="33">AM Wintry Mix</option>
                                                            <option value="34">PM Wintry Mix</option>
                                                            <option value="35">AM Snow</option>
                                                            <option value="36">PM Snow</option>
                                                            <option value="37">Snow</option>
                                                            <option value="38">Few Snow Showers</option>
                                                            <option value="39">Snow Showers</option>
                                                            <option value="40">Snow Showers Likely</option>
                                                            <option value="41">Blustery/Windy</option>
                                                            <option value="42">Increasing Clouds</option>
                                                            <option value="43">Decreasing Clouds</option>
                                                            <option value="44">Sunny/Wind</option>
                                                            <option value="45">Mostly Clear</option>
                                                            <option value="46">Partly Cloudy AM</option>
                                                            <option value="47">Partly Cloudy PM</option>
                                                            <option value="48">Foggy</option>
                                                            <option value="49">Sunny and Cold</option>
                                                            <option value="50">Rain</option>
                                                            <option value="51">Rain/Wind</option>
                                                            <option value="52">AM Rain/Lkly PM T-Storm</option>
                                                            <option value="53">AM T-Storm/Lkly PM Rain</option>
                                                            <option value="54">AM Rain/Lkly PM Rain</option>
                                                        </select>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-secondary text-center">
                                            <tr>
                                                <th scope="col" id="additional_3"><label>Additional:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page2-1-additional">
                                                        <div><label><input type="checkbox" name="page2-1-additional" value="1"> AM Fog</label></div>
                                                        <div><label><input type="checkbox" name="page2-1-additional" value="2"> PM Fog</label></div>
                                                        <div><label><input type="checkbox" name="page2-1-additional" value="3"> AM Clouds</label></div>
                                                        <div><label><input type="checkbox" name="page2-1-additional" value="4"> PM Clouds</label></div>
                                                        <div><label><input type="checkbox" name="page2-1-additional" value="5"> Foggy</label></div>
                                                        <div><label><input type="checkbox" name="page2-1-additional" value="6"> AM Drizzle</label></div>
                                                        <div><label><input type="checkbox" name="page2-1-additional" value="7"> PM Drizzle</label></div>
                                                        <div><label><input type="checkbox" name="page2-1-additional" value="8"> AM Snow Showers</label></div>
                                                        <div><label><input type="checkbox" name="page2-1-additional" value="9"> PM Snow Showers</label></div>
                                                        <div><label><input type="checkbox" name="page2-1-additional" value="10"> AM Showers</label></div>
                                                        <div><label><input type="checkbox" name="page2-1-additional" value="11"> PM Showers</label></div>
                                                        <div><label><input type="checkbox" name="page2-1-additional" value="12"> AM T-Storms</label></div>
                                                        <div><label><input type="checkbox" name="page2-1-additional" value="13"> PM T-Storms</label></div>
                                                        <div><label><input type="checkbox" name="page2-1-additional" value="14"> Windy</label></div>
                                                        <div><label><input type="checkbox" name="page2-1-additional" value="15"> Humid</label></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-primary text-center">
                                            <tr>
                                                <th scope="col" id="snow_3"><label>Snow:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page2-1-snow">
                                                        <div><label><input type="radio" name="page2-1-snow" value="1"> 0.1" - 1.0"</label></div>
                                                        <div><label><input type="radio" name="page2-1-snow" value="2"> 1.1" - 3.0"</label></div>
                                                        <div><label><input type="radio" name="page2-1-snow" value="3"> 3.1" - 6.0"</label></div>
                                                        <div><label><input type="radio" name="page2-1-snow" value="4"> 6.1" +</label></div>
                                                        <div><label><input type="radio" name="page2-1-snow" value="99" checked> None</label></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Day 4 -->
                            <div class="row mb-4">
                                <div class="col-sm-auto pb-2">
                                    <h5>Day 4</h5>
                                    <label class="sr-only">Day 4 high</label>
                                    <input type="number" name="page2-2-high" class="form-control temperature" maxlength="3" placeholder="High°F" id="id_page2-2-high">
                                    <label class="sr-only">Day 4 low</label>
                                    <input type="number" name="page2-2-low" class="form-control temperature" maxlength="3" placeholder="Low°F" id="id_page2-2-low">
                                    <p id="error-section-4" class="text-danger font-weight-bold temperature"></p>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-primary text-center">
                                            <tr>
                                                <th scope="col" id="sky_4"><label>Sky/Precip:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page2-2-sky_precip">
                                                        <select name="page2-2-sky_precip" class="form-select">
                                                            <option value="1">Sunny - P/C</option>
                                                            <option value="2">Sunny - AM/PM Clouds</option>
                                                            <option value="3">Sunny - Mostly Sunny</option>
                                                            <option value="4">Sunny - Hazy</option>
                                                            <option value="5">Mostly Sunny</option>
                                                            <option value="6">Partly Cloudy</option>
                                                            <option value="7">Mostly Cloudy</option>
                                                            <option value="8">Cloudy</option>
                                                            <option value="9">Drizzle</option>
                                                            <option value="10">Few Showers</option>
                                                            <option value="11">Showers Likely</option>
                                                            <option value="12">Showers</option>
                                                            <option value="13">T-Storms Likely</option>
                                                            <option value="14">T-Storms Early</option>
                                                            <option value="15">T-Storms Late</option>
                                                            <option value="16">A Few T-Storms</option>
                                                            <option value="17">AM Snow Showers</option>
                                                            <option value="18">PM Snow Showers</option>
                                                            <option value="19">AM T-Storms</option>
                                                            <option value="20">PM T-Storms</option>
                                                            <option value="21">AM Showers</option>
                                                            <option value="22">PM Showers</option>
                                                            <option value="23">AM Clouds/PM Sun</option>
                                                            <option value="24">AM Sun/PM Clouds</option>
                                                            <option value="25">Mostly Cloudy/Wind</option>
                                                            <option value="26">Mostly Sunny/Wind</option>
                                                            <option value="27">Partly Cloudy/Wind</option>
                                                            <option value="28">Few T-Storms</option>
                                                            <option value="29">AM Drizzle</option>
                                                            <option value="30">PM Drizzle</option>
                                                            <option value="31">Rain/Snow Showers</option>
                                                            <option value="32">Wintry Mix</option>
                                                            <option value="33">AM Wintry Mix</option>
                                                            <option value="34">PM Wintry Mix</option>
                                                            <option value="35">AM Snow</option>
                                                            <option value="36">PM Snow</option>
                                                            <option value="37">Snow</option>
                                                            <option value="38">Few Snow Showers</option>
                                                            <option value="39">Snow Showers</option>
                                                            <option value="40">Snow Showers Likely</option>
                                                            <option value="41">Blustery/Windy</option>
                                                            <option value="42">Increasing Clouds</option>
                                                            <option value="43">Decreasing Clouds</option>
                                                            <option value="44">Sunny/Wind</option>
                                                            <option value="45">Mostly Clear</option>
                                                            <option value="46">Partly Cloudy AM</option>
                                                            <option value="47">Partly Cloudy PM</option>
                                                            <option value="48">Foggy</option>
                                                            <option value="49">Sunny and Cold</option>
                                                            <option value="50">Rain</option>
                                                            <option value="51">Rain/Wind</option>
                                                            <option value="52">AM Rain/Lkly PM T-Storm</option>
                                                            <option value="53">AM T-Storm/Lkly PM Rain</option>
                                                            <option value="54">AM Rain/Lkly PM Rain</option>
                                                        </select>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-secondary text-center">
                                            <tr>
                                                <th scope="col" id="additional_4"><label>Additional:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page2-2-additional">
                                                        <div><label><input type="checkbox" name="page2-2-additional" value="1"> AM Fog</label></div>
                                                        <div><label><input type="checkbox" name="page2-2-additional" value="2"> PM Fog</label></div>
                                                        <div><label><input type="checkbox" name="page2-2-additional" value="3"> AM Clouds</label></div>
                                                        <div><label><input type="checkbox" name="page2-2-additional" value="4"> PM Clouds</label></div>
                                                        <div><label><input type="checkbox" name="page2-2-additional" value="5"> Foggy</label></div>
                                                        <div><label><input type="checkbox" name="page2-2-additional" value="6"> AM Drizzle</label></div>
                                                        <div><label><input type="checkbox" name="page2-2-additional" value="7"> PM Drizzle</label></div>
                                                        <div><label><input type="checkbox" name="page2-2-additional" value="8"> AM Snow Showers</label></div>
                                                        <div><label><input type="checkbox" name="page2-2-additional" value="9"> PM Snow Showers</label></div>
                                                        <div><label><input type="checkbox" name="page2-2-additional" value="10"> AM Showers</label></div>
                                                        <div><label><input type="checkbox" name="page2-2-additional" value="11"> PM Showers</label></div>
                                                        <div><label><input type="checkbox" name="page2-2-additional" value="12"> AM T-Storms</label></div>
                                                        <div><label><input type="checkbox" name="page2-2-additional" value="13"> PM T-Storms</label></div>
                                                        <div><label><input type="checkbox" name="page2-2-additional" value="14"> Windy</label></div>
                                                        <div><label><input type="checkbox" name="page2-2-additional" value="15"> Humid</label></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="col-sm-auto">
                                    <table class="table table-borderless table-hover">
                                        <thead class="table-primary text-center">
                                            <tr>
                                                <th scope="col" id="snow_4"><label>Snow:</label></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div id="id_page2-2-snow">
                                                        <div><label><input type="radio" name="page2-2-snow" value="1"> 0.1" - 1.0"</label></div>
                                                        <div><label><input type="radio" name="page2-2-snow" value="2"> 1.1" - 3.0"</label></div>
                                                        <div><label><input type="radio" name="page2-2-snow" value="3"> 3.1" - 6.0"</label></div>
                                                        <div><label><input type="radio" name="page2-2-snow" value="4"> 6.1" +</label></div>
                                                        <div><label><input type="radio" name="page2-2-snow" value="99" checked> None</label></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <p class="text-center mt-4">
                                <button type="button" class="btn btn-warning" onclick="goToStep1()">
                                    <i class="fas fa-arrow-left"></i> Back to Day 1
                                </button>
                                <button type="button" class="btn btn-primary" onclick="goToStep3()">
                                    <i class="fas fa-eye"></i> View Forecast Summary
                                </button>
                            </p>
                        </div>
                </div>

                <!-- Step 3: Summary -->
                <div id="step3" class="wizard-step" style="display: none;">
                    <form name="forecast_summary" class="pt-3">
                        <input type="hidden" name="forecast_wizard_view-current_step" value="page3" id="id_forecast_wizard_view-current_step">
                        <input type="hidden" name="page3-forecast_date" value="2025-11-13" id="id_page3-forecast_date">

                        <table class="table table-hover notsowide mx-auto text-center">
                            <thead class="table-primary">
                                <tr>
                                    <th scope="col">Forecast Period</th>
                                    <th scope="col">High</th>
                                    <th scope="col">Low</th>
                                    <th scope="col">Sky/Precip</th>
                                    <th scope="col">Additional</th>
                                    <th scope="col">Snow</th>
                                    <th scope="col">Timing</th>
                                </tr>
                            </thead>
                            <tbody id="summaryTableBody">
                                <!-- Summary rows will be populated by JavaScript -->
                            </tbody>
                        </table>

                        <p class="text-center mt-4">
                            <button type="button" class="btn btn-warning" onclick="goToStep1()">
                                <i class="fas fa-arrow-left"></i> Back to Day 1
                            </button>
                            <button type="button" class="btn btn-warning me-2" onclick="goToStep2()">
                                <i class="fas fa-arrow-left"></i> Previous Step
                            </button>
                            <button type="button" class="btn btn-success" onclick="submitForecast()">
                                <i class="fas fa-check"></i> Submit
                            </button>
                        </p>
                    </form>
                </div>

                    </div>


            </div>
        </div>

        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Configuration
            const SUPABASE_URL = "https://jpdhzwfsomuompbcixmf.supabase.co";
            const SUPABASE_ANON_KEY =
                "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpwZGh6d2Zzb211b21wYmNpeG1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NjIwNzQsImV4cCI6MjA3ODUzODA3NH0.MJG3bMLMfhWqU1p7aI0eJX3dnA8t85MBZWgadHP-PPY";

            // Initialize Supabase
            const supabase = window.supabase.createClient(
                SUPABASE_URL,
                SUPABASE_ANON_KEY,
            );

            // State
            let currentUser = null;
            let userProfile = null;
            let stationInfo = null;
            let currentStepNum = 1;
            let forecastData = {};
            let autoSaveTimeout = null;

            // Initialize
            document.addEventListener("DOMContentLoaded", async () => {
                // Add debug info to console
                console.log("=== TV Pro Interface Debug Info ===");
                console.log("Supabase URL:", SUPABASE_URL);
                console.log("Current time:", new Date().toISOString());

                await checkAuth();
                if (currentUser) {
                    console.log(
                        "User authenticated, proceeding with profile load",
                    );
                    await loadUserProfile();
                    if (userProfile) {
                        await loadStationInfo();
                        setupEventListeners();
                        updateDates();
                        loadSavedData();
                        console.log(
                            "=== TV Pro Interface Successfully Loaded ===",
                        );
                    }
                } else {
                    console.log(
                        "No authenticated user found, redirecting to index.html",
                    );
                }
            });

            // Authentication
            async function checkAuth() {
                try {
                    const {
                        data: { session },
                        error,
                    } = await supabase.auth.getSession();

                    if (error) {
                        console.error("Auth session error:", error);
                        window.location.href = "index.html";
                        return;
                    }

                    if (!session) {
                        console.log("No active session found");
                        window.location.href = "index.html";
                        return;
                    }

                    console.log("Session found for user:", session.user.email);
                    currentUser = session.user;
                } catch (error) {
                    console.error("Unexpected auth error:", error);
                    window.location.href = "index.html";
                }
            }

            async function loadUserProfile() {
                try {
                    console.log("=== Loading Profile Debug ===");
                    console.log("Current user ID:", currentUser.id);
                    console.log("Current user email:", currentUser.email);
                    console.log("Attempting to query user_profiles...");
                    const { data, error } = await supabase
                        .from("user_profiles")
                        .select("*")
                        .eq("user_id", currentUser.id)
                        .single();

                    console.log("Query result - data:", data);
                    console.log("Query result - error:", error);

                    if (error) {
                        console.error("Profile query error:", error);
                        if (error.code === "PGRST116") {
                            alert(`DEBUG: Profile not found for user ${currentUser.email}.

Please ask an administrator to run this SQL in Supabase:

INSERT INTO user_profiles (user_id, role, assigned_station_id, full_name)
VALUES ('${currentUser.id}', 'tvpro', (SELECT id FROM stations LIMIT 1), '${currentUser.email || "TV Pro User"}');`);
                        } else {
                            alert(
                                "Error accessing user profile. Check RLS policies or contact administrator.",
                            );
                        }
                        await handleLogout();
                        return;
                    }

                    if (!data) {
                        console.error("No profile data returned");
                        alert(
                            "User profile not found. Please contact administrator.",
                        );
                        await handleLogout();
                        return;
                    }

                    if (data.role !== "tvpro") {
                        console.error(
                            "Invalid role for TV Pro interface:",
                            data.role,
                        );
                        alert(
                            `Access denied. Your role is '${data.role}' but this interface is for TV Pro users only.`,
                        );
                        window.location.href = "index.html";
                        return;
                    }

                    console.log("Profile loaded successfully:", data);
                    userProfile = data;
                    document.getElementById("userDisplayName").textContent =
                        data.full_name || "TV Pro";
                } catch (error) {
                    console.error("Unexpected error loading profile:", error);
                    alert(
                        "Unexpected error loading user profile. Please contact administrator.",
                    );
                    await handleLogout();
                }
            }

            async function loadStationInfo() {
                try {
                    const { data, error } = await supabase
                        .from("stations")
                        .select(
                            `
                        *,
                        locations (
                            name
                        )
                    `,
                        )
                        .eq("id", userProfile.assigned_station_id)
                        .single();

                    if (error || !data) {
                        console.error("Station not found:", error);
                        alert(
                            "Assigned station not found. Please contact administrator.",
                        );
                        return;
                    }

                    stationInfo = data;
                    document.getElementById("stationName").textContent =
                        data.call_sign;
                    document.getElementById("stationMarket").textContent =
                        data.locations.name;
                } catch (error) {
                    console.error("Error loading station:", error);
                    alert("Error loading station information.");
                }
            }

            // Event Listeners
            function setupEventListeners() {
                // Auto-save on input changes
                document.querySelectorAll("input").forEach((input) => {
                    input.addEventListener("input", handleInputChange);
                });

                // Also handle select dropdown changes
                document.querySelectorAll("select").forEach((select) => {
                    select.addEventListener("change", handleInputChange);
                });

                // Form validation - only if the form exists
                const forecastForm = document.getElementById("forecastForm");
                if (forecastForm) {
                    forecastForm.addEventListener("change", validateCurrentStep);
                }
            }

            // Input handling
            function handleInputChange(e) {
                clearTimeout(autoSaveTimeout);
                const { name, value, type } = e.target;

                // Debug: Log select changes
                if (type === "select-one" || e.target.tagName === "SELECT") {
                    console.log(`Select changed: ${name} = ${value}`);
                }

                // Store in forecast data
                if (name) {
                    if (type === "checkbox") {
                        // For checkboxes, store as array if multiple values exist
                        if (!forecastData[name]) {
                            forecastData[name] = [];
                        }
                        if (e.target.checked) {
                            if (!forecastData[name].includes(value)) {
                                forecastData[name].push(value);
                            }
                        } else {
                            forecastData[name] = forecastData[name].filter(v => v !== value);
                        }
                        // Convert to empty string if no checkboxes checked
                        if (forecastData[name].length === 0) {
                            forecastData[name] = "";
                        }
                    } else if (type === "radio") {
                        forecastData[name] = value;
                    } else {
                        // For text inputs, numbers, and select dropdowns
                        forecastData[name] = value;
                    }
                }

                // Auto-save after 2 seconds
                autoSaveTimeout = setTimeout(() => {
                    saveForecastData();
                }, 2000);

                // Clear any error for this field
                const errorElement = document.getElementById(`${name}_error`);
                if (errorElement) {
                    errorElement.classList.add("hidden");
                    e.target.classList.remove("is-invalid");
                }
            }

            // Wizard step management
            function goToStep1() {
                showStep(1);
            }

            function goToStep2() {
                if (validateStep1()) {
                    showStep(2);
                }
            }

            function goToStep3() {
                if (validateStep2()) {
                    populateSummary();
                    showStep(3);
                }
            }

            function showStep(stepNum) {
                // Hide all steps
                document.querySelectorAll(".wizard-step").forEach((step) => {
                    step.style.display = "none";
                });

                // Show current step
                document.getElementById(`step${stepNum}`).style.display =
                    "block";

                // Update step indicator
                document.getElementById("currentStep").textContent = stepNum;

                const titles = ["Day 1", "Days 2-4", "Summary"];
                document.getElementById("wizardStepTitle").textContent =
                    titles[stepNum - 1];

                currentStep = stepNum;
            }

            function validateStep1() {
                // Validate required fields for step 1
                const highTemp = document.querySelector(
                    'input[name="page1-high"]',
                ).value;
                const lowTemp = document.querySelector(
                    'input[name="page1-low"]',
                ).value;

                if (!highTemp) {
                    alert("Please enter a high temperature for Day 1");
                    return false;
                }

                if (!lowTemp) {
                    alert("Please enter a low temperature for Day 1 Night");
                    return false;
                }

                return true;
            }

            function validateStep2() {
                // Validate required fields for step 2
                const requiredFields = [
                    "page2-0-high",
                    "page2-0-low",
                    "page2-1-high",
                    "page2-1-low",
                    "page2-2-high",
                    "page2-2-low",
                ];

                for (const fieldName of requiredFields) {
                    const field = document.querySelector(
                        `input[name="${fieldName}"]`,
                    );
                    if (field && !field.value) {
                        alert(`Please fill in all required temperature fields`);
                        return false;
                    }
                }

                return true;
            }

            function populateSummary() {
                // Debug: Log the forecastData to see what we have
                console.log("Forecast data:", forecastData);
                console.log("Day 3 Sky/Precip:", forecastData["page2-1-sky_precip"]);
                console.log("Day 4 Sky/Precip:", forecastData["page2-2-sky_precip"]);

                const tbody = document.getElementById("summaryTableBody");
                const today = new Date();
                const dates = [
                    today,
                    new Date(today.getTime() + 24 * 60 * 60 * 1000),
                    new Date(today.getTime() + 2 * 24 * 60 * 60 * 1000),
                    new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000),
                ];

                const summaryRows = [
                    {
                        period: `${dates[0].toLocaleDateString("en-US", { weekday: "short", month: "numeric", day: "numeric" })}`,
                        high: forecastData["page1-high"] || "",
                        low: "",
                        skyPrecip: getSkyPrecipText(
                            forecastData["page1-sky_precip_high"],
                        ),
                        additional: getAdditionalText(
                            forecastData["page1-additional_high"],
                        ),
                        snow: getSnowText(forecastData["page1-snow_high"]),
                        timing: getTimingText(
                            forecastData["page1-precip_time_high"],
                        ),
                    },
                    {
                        period: `${dates[0].toLocaleDateString("en-US", { weekday: "short", month: "numeric", day: "numeric" })} Night`,
                        high: "",
                        low: forecastData["page1-low"] || "",
                        skyPrecip: getSkyPrecipText(
                            forecastData["page1-sky_precip_low"],
                        ),
                        additional: getAdditionalText(
                            forecastData["page1-additional_low"],
                        ),
                        snow: getSnowText(forecastData["page1-snow_low"]),
                        timing: "",
                    },
                    {
                        period: `${dates[1].toLocaleDateString("en-US", { weekday: "short", month: "numeric", day: "numeric" })}`,
                        high: forecastData["page2-0-high"] || "",
                        low: forecastData["page2-0-low"] || "",
                        skyPrecip: getSkyPrecipText(
                            forecastData["page2-0-sky_precip"],
                        ),
                        additional: getAdditionalText(
                            forecastData["page2-0-additional"],
                        ),
                        snow: getSnowText(forecastData["page2-0-snow"]),
                        timing: "",
                    },
                    {
                        period: `${dates[2].toLocaleDateString("en-US", { weekday: "short", month: "numeric", day: "numeric" })}`,
                        high: forecastData["page2-1-high"] || "",
                        low: forecastData["page2-1-low"] || "",
                        skyPrecip: getSkyPrecipText(
                            forecastData["page2-1-sky_precip"],
                        ),
                        additional: getAdditionalText(
                            forecastData["page2-1-additional"],
                        ),
                        snow: getSnowText(forecastData["page2-1-snow"]),
                        timing: "",
                    },
                    {
                        period: `${dates[3].toLocaleDateString("en-US", { weekday: "short", month: "numeric", day: "numeric" })}`,
                        high: forecastData["page2-2-high"] || "",
                        low: forecastData["page2-2-low"] || "",
                        skyPrecip: getSkyPrecipText(
                            forecastData["page2-2-sky_precip"],
                        ),
                        additional: getAdditionalText(
                            forecastData["page2-2-additional"],
                        ),
                        snow: getSnowText(forecastData["page2-2-snow"]),
                        timing: "",
                    },
                ];

                tbody.innerHTML = summaryRows
                    .map(
                        (row) => `
                    <tr>
                        <td>${row.period}</td>
                        <td>${row.high ? row.high + "°" : ""}</td>
                        <td>${row.low ? row.low + "°" : ""}</td>
                        <td>${row.skyPrecip}</td>
                        <td>${row.additional}</td>
                        <td>${row.snow}</td>
                        <td>${row.timing}</td>
                    </tr>
                `,
                    )
                    .join("");
            }

            function getSkyPrecipText(value) {
                const mapping = {
                    1: "Sunny - P/C",
                    2: "M/C - Cloudy",
                    3: "Rain",
                    4: "Snow",
                    5: "Ice",
                    6: "Mixed",
                };
                return mapping[value] || "";
            }

            function getAdditionalText(values) {
                if (!values || !Array.isArray(values) || values.length === 0)
                    return "None";
                const mapping = {
                    1: "Severe T-Storm",
                    2: "Windy",
                    3: "Dense Fog",
                };
                return values.map((v) => mapping[v]).join(", ") || "None";
            }

            function getSnowText(value) {
                if (value === "99") return "None";
                const mapping = {
                    1: '0.1" - 1.0"',
                    2: '1.1" - 3.0"',
                    3: '3.1" - 6.0"',
                    4: '6.1" +',
                };
                return mapping[value] || "None";
            }

            function getTimingText(values) {
                if (!values || !Array.isArray(values) || values.length === 0)
                    return "";
                const mapping = {
                    1: "7AM-Noon",
                    2: "Noon-6PM",
                    3: "6PM-10PM",
                };
                return values.map((v) => mapping[v]).join(", ") || "";
            }

            // Step management (legacy)
            function changeStep(direction) {
                if (!validateCurrentStep()) {
                    return;
                }

                currentStepNum += direction;
                updateStepDisplay();
            }

            function updateStepDisplay() {
                // Hide all steps
                document
                    .querySelectorAll(".forecast-section")
                    .forEach((section) => {
                        section.classList.add("hidden");
                    });

                // Show current step
                const currentStepElement = document.getElementById(
                    `step${currentStepNum}`,
                );
                if (currentStepElement) {
                    currentStepElement.classList.remove("hidden");
                    currentStepElement.classList.add("fade-in");
                }

                // Update step indicator
                document.getElementById("currentStep").textContent =
                    currentStepNum;

                // Update navigation buttons
                const prevBtn = document.getElementById("prevBtn");
                const nextBtn = document.getElementById("nextBtn");
                const submitBtn = document.getElementById("submitBtn");

                prevBtn.style.display = currentStepNum === 1 ? "none" : "block";

                if (currentStepNum === 6) {
                    nextBtn.classList.add("hidden");
                    submitBtn.classList.remove("hidden");
                } else {
                    nextBtn.classList.remove("hidden");
                    submitBtn.classList.add("hidden");
                }

                validateCurrentStep();
            }

            // Validation
            function validateCurrentStep() {
                let isValid = true;

                // Use the current step from the wizard
                const currentStepElement = document.querySelector('.wizard-step:not([style*="display: none"])');
                let stepNum = 1;
                if (currentStepElement) {
                    stepNum = parseInt(currentStepElement.id.replace('step', ''));
                }

                if (stepNum === 1) {
                    const highTemp = document.querySelector('input[name="page1-high"]');
                    const lowTemp = document.querySelector('input[name="page1-low"]');

                    if (!highTemp || !highTemp.value || highTemp.value === "") {
                        if (highTemp) highTemp.classList.add("is-invalid");
                        isValid = false;
                    } else {
                        if (highTemp) highTemp.classList.remove("is-invalid");
                    }

                    if (!lowTemp || !lowTemp.value || lowTemp.value === "") {
                        if (lowTemp) lowTemp.classList.add("is-invalid");
                        isValid = false;
                    } else {
                        if (lowTemp) lowTemp.classList.remove("is-invalid");
                    }
                } else if (stepNum === 2) {
                    // Validate Day 2, 3, 4 temperatures
                    const requiredFields = [
                        "page2-0-high", "page2-0-low",
                        "page2-1-high", "page2-1-low",
                        "page2-2-high", "page2-2-low"
                    ];

                    requiredFields.forEach(fieldName => {
                        const field = document.querySelector(`input[name="${fieldName}"]`);
                        if (!field || !field.value || field.value === "") {
                            if (field) field.classList.add("is-invalid");
                            isValid = false;
                        } else {
                            if (field) field.classList.remove("is-invalid");
                        }
                    });
                }

                // Update status indicator
                updateStatusIndicator(isValid, stepNum);

                return isValid;
            }

            function updateStatusIndicator(isValid, stepNum) {
                const indicator = document.getElementById("statusIndicator");

                if (isValid && stepNum === 3) {
                    indicator.className = "status-indicator status-saved";
                    indicator.innerHTML =
                        '<i class="fas fa-check me-2"></i>Ready to submit forecast';
                } else if (isValid) {
                    indicator.className = "status-indicator status-pending";
                    indicator.innerHTML =
                        '<i class="fas fa-edit me-2"></i>Continue to next step';
                } else {
                    indicator.className = "status-indicator status-error";
                    indicator.innerHTML =
                        '<i class="fas fa-exclamation-triangle me-2"></i>Please complete all required fields';
                }
            }

            // Data management
            function mapFormDataToDatabaseColumns(formData) {
                // Map form field names to database column names
                const mappedData = {};

                // Day 1 (Day)
                if (formData["page1-high"]) mappedData.day1_high = formData["page1-high"];
                if (formData["page1-low"]) mappedData.day1_low = formData["page1-low"];
                if (formData["page1-sky_precip_high"]) mappedData.day1_sky_precip_high = formData["page1-sky_precip_high"];
                if (formData["page1-additional_high"]) mappedData.day1_additional_high = formData["page1-additional_high"];
                if (formData["page1-snow_high"]) mappedData.day1_snow_high = formData["page1-snow_high"];
                if (formData["page1-precip_time_high"]) mappedData.day1_precip_time_high = formData["page1-precip_time_high"];

                // Day 1 (Night)
                if (formData["page1-sky_precip_low"]) mappedData.day1_sky_precip_low = formData["page1-sky_precip_low"];
                if (formData["page1-additional_low"]) mappedData.day1_additional_low = formData["page1-additional_low"];
                if (formData["page1-snow_low"]) mappedData.day1_snow_low = formData["page1-snow_low"];

                // Day 2
                if (formData["page2-0-high"]) mappedData.day2_high = formData["page2-0-high"];
                if (formData["page2-0-low"]) mappedData.day2_low = formData["page2-0-low"];
                if (formData["page2-0-sky_precip"]) mappedData.day2_sky_precip = formData["page2-0-sky_precip"];
                if (formData["page2-0-additional"]) mappedData.day2_additional = formData["page2-0-additional"];
                if (formData["page2-0-snow"]) mappedData.day2_snow = formData["page2-0-snow"];

                // Day 3
                if (formData["page2-1-high"]) mappedData.day3_high = formData["page2-1-high"];
                if (formData["page2-1-low"]) mappedData.day3_low = formData["page2-1-low"];
                if (formData["page2-1-sky_precip"]) mappedData.day3_sky_precip = formData["page2-1-sky_precip"];
                if (formData["page2-1-additional"]) mappedData.day3_additional = formData["page2-1-additional"];
                if (formData["page2-1-snow"]) mappedData.day3_snow = formData["page2-1-snow"];

                // Day 4
                if (formData["page2-2-high"]) mappedData.day4_high = formData["page2-2-high"];
                if (formData["page2-2-low"]) mappedData.day4_low = formData["page2-2-low"];
                if (formData["page2-2-sky_precip"]) mappedData.day4_sky_precip = formData["page2-2-sky_precip"];
                if (formData["page2-2-additional"]) mappedData.day4_additional = formData["page2-2-additional"];
                if (formData["page2-2-snow"]) mappedData.day4_snow = formData["page2-2-snow"];

                return mappedData;
            }

            async function saveForecastData() {
                try {
                    const forecastDate = new Date().toISOString().split("T")[0];

                    // Map form field names to database column names
                    const dbData = mapFormDataToDatabaseColumns(forecastData);

                    const { error } = await supabase.from("forecasts").upsert(
                        {
                            station_id: stationInfo.id,
                            forecast_date: forecastDate,
                            ...dbData,
                            updated_at: new Date().toISOString(),
                        },
                        {
                            onConflict: "station_id,forecast_date",
                        },
                    );

                    if (error) throw error;

                    console.log("Data saved successfully");
                } catch (error) {
                    console.error("Error saving data:", error);
                }
            }

            async function loadSavedData() {
                try {
                    const forecastDate = new Date().toISOString().split("T")[0];

                    const { data, error } = await supabase
                        .from("forecasts")
                        .select("*")
                        .eq("station_id", stationInfo.id)
                        .eq("forecast_date", forecastDate)
                        .single();

                    if (data && !error) {
                        forecastData = data;
                        populateForm();
                    }
                } catch (error) {
                    console.log("No saved data found for today");
                }
            }

            function populateForm() {
                Object.keys(forecastData).forEach((key) => {
                    if (
                        key.startsWith("d1_") ||
                        key.startsWith("d2_") ||
                        key.startsWith("d3_") ||
                        key.startsWith("d4_")
                    ) {
                        const input = document.querySelector(
                            `[name="${key}"], #${key}`,
                        );
                        if (input) {
                            if (input.type === "radio") {
                                const radio = document.querySelector(
                                    `[name="${key}"][value="${forecastData[key]}"]`,
                                );
                                if (radio) radio.checked = true;
                            } else {
                                input.value = forecastData[key] || "";
                            }
                        }
                    }
                });
            }

            // Submit
            async function submitForecast() {
                if (!validateCurrentStep()) {
                    alert(
                        "Please complete all required fields before submitting.",
                    );
                    return;
                }

                try {
                    await saveForecastData();
                    alert("Forecast submitted successfully!");

                    // Optionally redirect to a confirmation page
                    // window.location.href = 'confirmation.html';
                } catch (error) {
                    console.error("Error submitting forecast:", error);
                    alert("Error submitting forecast. Please try again.");
                }
            }

            // Logout
            async function handleLogout() {
                await supabase.auth.signOut();
                window.location.href = "index.html";
            }

            // Utility functions
            function updateDates() {
                const today = new Date();
                const options = {
                    weekday: "long",
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                };

                // Update current date if element exists
                const currentDateElement = document.getElementById("currentDate");
                if (currentDateElement) {
                    currentDateElement.textContent = `Today is ${today.toLocaleDateString("en-US", options)}`;
                }

                // Set Day 1 date (tomorrow)
                const day1 = new Date(today);
                day1.setDate(day1.getDate() + 1);
                document.getElementById("day1Date").textContent =
                    day1.toLocaleDateString("en-US", options);
            }

            // Generate additional steps (this would be expanded based on your exact requirements)
            // Additional steps are now directly in HTML - no need to generate them
        </script>
    </body>
</html>
